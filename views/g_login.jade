extends ./g_layout.jade
block vars
	- var page = 'login'

block head
	title Se connecter
	meta(name='description', content='Connectez-vous pour devenir bénévole ou trouver des bénévoles')
block content
	#map-section.container-fluid
		.row
			.col-md-6.col-md-offset-3
				.page-header
					h1 #{__('signin')}
					if error == 1
						p.alert.alert-danger #{__('g_login_wrong_mail')}
					if error == 2
						p.alert.alert-danger #{__('g_login_not_verified')}
					p.alert.alert-success.hidden#forgotten-success
			.col-md-2.col-md-offset-1
				.page-header
					h4 #{__('no_account')}
				button.btn.btn-default.dropdown-toggle(href='/register' data-toggle="dropdown") #{__('signup')}
					span.caret
				ul.dropdown-menu#drop-down-but
					li
						a.toggle-but(href='register_organism') #{__('g_org')}
					li
						a.toggle-but(href='register_volunteer') #{__('g_vol')}

		.row
			.col-md-5.col-md-offset-3
				form#loginform(action="/login", method="post", role='form')
					.input-group.conn-input
						span#basic-addon1.input-group-addon #{__('email')}
						input#mail.form-control(type='email', placeholder='Ex: contact@simplyk.org', name='email', aria-describedby='basic-addon1', required)
					.input-group.conn-input
						span#basic-addon1.input-group-addon #{__('password')}
						input#password.form-control(type='password', placeholder='', name='password', aria-describedby='basic-addon1', required)
					input.btn.btn-default#login_button(type='submit', form='loginform', value=__('signin'))
				a(data-toggle='modal' data-target='#forgottenModal', style='cursor: pointer;') #{__('forgotten_password')} ?
				.modal.fade(tabindex='-1', role='dialog' aria-labelledby="extraModalLabel", id='forgottenModal')
					div.modal-dialog(role='document')
						form(id='forgottenForm', role='form').modal-content
							.modal-header
								button(type='button' class="close" data-dismiss="modal" aria-label="Close")
									span(aria-hidden='true')
									h4.modal-title #{__('forgotten_password')}
							div.modal-body
								p.alert.alert-danger.hidden#forgotten-danger
								label(for='email') #{__('email')}
								input.form-control(type='email', name='email', required)
							div.modal-footer
								input.btn.btn-warning(type='submit', form='forgottenForm', value=__('reset_password'))
								a.btn.btn-default(data-dismiss='modal') #{__('close')}


block footscript
	script(type='text/javascript').
		'use strict';
		$(document).ready(function(){
			if (env == 'prod') {
				amplitude.getInstance().logEvent('g_visit_login');
				$('#loginform').submit(function(){
					amplitude.getInstance().logEvent('g_login');
				});
			}
			$('#forgottenForm').submit(function(event){
				event.preventDefault();
				console.log('Submit form');
				$.post('/forgottenpassword', $('#forgottenForm').serialize())
				.done(function(data){
					console.log('On est dans le callback done !');
					$('#forgottenModal').modal('toggle');
					console.log('JSON.stringify(data) : ' + JSON.stringify(data));
					console.log('Mot de passe réinitialisé !');
					$('#forgotten-success').removeClass('hidden');
					$('#forgotten-success').html('Mot de passe réinitialisé ! Un email d\'instructions t\'a été envoyé :)');
				})
				.fail(function(data){
					console.log('On est dans le callback fail !');
					console.log('Erreur !');
					$('#forgotten-danger').removeClass('hidden');
					console.log(data.error);
					$('#forgotten-danger').html(' ' + data.responseJSON.error);
					console.log('JSON.stringify(data) : ' + JSON.stringify(data));
				});
			});
		});