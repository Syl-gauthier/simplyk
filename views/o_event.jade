extends ./g_layout.jade
block vars
	- var page = 'event'


block head
	title Bénévoles à court terme
	meta(name='description', content='Gère tes bénévoles inscrits à court terme')

		
block content
	.container-fluid
		.row.fill
			.col-md-8.col-md-offset-2.no-side-padding
				p
					h1.inline.intitule= event.intitule
					i.fa.fa-pencil.fa-xs.edit(style="cursor: pointer" type='intitule')
				p Adresse: #{event.address}
				p #{event.description}
				if (error && (error.length > 0))
					p.alert.alert-danger= error
				each act, act_i in event.acts
					li.list-group-item(id= event._id)
						.panel.panel-default
							.panel-heading
								div.media-left.media-middle
									a(href='profile')
										img.media-object.little-img(src='/images/clouds.jpg')
								div.media-body
									h4.media-heading <b>#{act.intitule}</b>
									h6
										i.fa.fa-map-marker
										p.inline Adresse : #{event.address}
							.panel-body
								each day, day_i in act.days
									h4
										h5.inline <b>#{date.printDate(day.day)} : </b>
										h6.inline
											i.fa.fa-user
											p.inline= day.applicants.length+' bénévoles se sont inscrits'
											p.inline= ' (' + day.vol_nb +' places disponibles'
											i.fa.fa-pencil.fa-xs.edit.inline(style="cursor: pointer" type='vol_nb' vol_nb=day.vol_nb)
											p.inline )
										h6 De #{day.start_time} à #{day.end_time}
									if day.vols.length
										h5 <b> Liste des bénévoles </b>
										ul.list-group
											each vol, vol_i in day.vols
												li.list-group-item
													div.media
														div.media-left.media-middle
															a(href='/volunteer/profile')
															div.media-body
																h4.media-heading <b>#{vol.firstname} #{vol.lastname}</b>
																h6
																	i.fa.fa-at
																	p.inline #{vol.email}
																if vol.phone
																	h6
																		i.fa.fa-phone
																		p.inline #{vol.phone}
																else
																	h6
																if vol.birthdate
																	h6
																		i.fa.fa-birthday-cake
																		p.inline #{date.printDate(vol.birthdate)}
																else
																	h6
															each event, event_i in vol.events
																if ((Date.parse(event.day) == Date.parse(day.day)) && (act._id.toString() == event.activity_id.toString()))
																	if Date.parse(day.day)<Date.now()
																		if event.hours_pending > event.hours_done
																			div.media-right(id=act._id day=event.day)
																				p= '***** Participation de ' + event.hours_pending + ' h ?'
																				button.btn.btn-default(class='confirmHoursButton' id=vol._id) Confirmer
																				button.btn.btn-warning(id='correctionModalButton' type= 'button' data-toggle='modal' data-target='#correctionModal') Non
																				#correctionModal.modal.fade(tabindex='-1', role='dialog' aria-labelledby="correctionModalLabel")
																					div.modal-dialog(role='document')
																						form.modal-content(action='/organism/correcthours' method='post' id='correctHoursForm')
																							.modal-header
																								button(type='button' class="close" data-dismiss="modal" aria-label="Close")
																									span(aria-hidden='true')
																									h4.modal-title Correction d'horaires
																								div.modal-body
																									p Les heures mentionnées par le bénévole ne reflètent pas la réalité ?
																									div.form-group
																										label(for='correctionHoursInput') Heures réellement réalisées 
																										input.form-control(type='Number' id='correctionHoursInput' required)
																								div.modal-footer
																									button.btn.btn-default(data-dismiss='modal') Annuler
																									button.btn.btn-warning(type='submit' form='correctHoursForm') Envoyer
																		if (event.hours_done > event.hours_pending) && event.hours_done != 0
																			div.media-right
																				p= ' Participation de ' + event.hours_done + ' h'
																		if (event.hours_done == event.hours_pending) && event.hours_done == 0
																			div.media-right
																				p= 'Participation non-confirmée'
																	else
																		div.media-right
																			button.btn.btn-default(type='button')
																				a(href='mailto:'+vol.email+'?subject=Participation%20à%20:%20'+event.intitule, target='_blank') Contactez


block footscript
	script(type='text/javascript', src='/javascripts/date_browser.js')
	script(type='text/javascript').
		$(document).ready(function(){
			$('#correctionModal').on('shown.bs.modal', function () {
				$('#correctionModalButton').focus()
			});
			$('.confirmHoursButton').click(function(){
				var vol_id = $(this).attr('id');
				var act_id = $(this).parent().attr('id');
				var day = $(this).parent().attr('day');
				var input = $(this);
				$.post('/organism/confirmhours', {vol_id: vol_id, act_id: act_id, day: day}).done(function(data, status){
					if(data.error){
						console.log("Remarque: " + data.error);
						input.replaceWith('<p>Il y a une erreur</p>');
					}
					else {
						console.log("Post request done.");
						input.replaceWith('<p>Heures confirmées</p>');
					}
				});
			});
			$('.edit').click(function(){
				const type = $(this).attr('type');
				if(type == 'vol_nb'){
					let div = $(this).parent();
					div.html("<form name='edit-form' method='post' action='/edit-event'><p>Nombre de bénévoles recherchés</p><input type='number' min='1' max='400' placeholder='"+$(this).attr('vol_nb')+"' name='vol_nb'></input><input class='hidden' name='url' value="+window.location.pathname+"></input><input type='submit' value='Modifier'></input></form>");
				} else if (type == 'description'){
					let div = $(this).parent();
					div.html("<form name='edit-form' method='post' action='/edit-event'><p>Nouvelle description</p><textarea rows='6' name='description'></textarea><input class='hidden' name='url' value="+window.location.pathname+"></input><input type='submit' value='Modifier'></input></form>");
				} else if (type == 'intitule'){
					let div = $('h1.intitule');
					console.info(JSON.stringify(div));
					console.info(div.text());
					div.html("<form name='edit-form' method='post' action='/edit-event'><input type='text' placeholder='"+div.text()+"' name='intitule'></input><input class='hidden' name='url' value="+window.location.pathname+"></input><input type='submit' value='Modifier'></input></form>");
				}
			})
		});
